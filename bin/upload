#! /usr/bin/env bash

tag=$(git describe --tags --abbrev=0 || echo "0.0")
count=$(git rev-list --count HEAD ^"${tag}" || git rev-list --count HEAD)
cd rockspec || exit 1
for rockspec in *-master-1.rockspec; do
  name=${rockspec%%-master-1.rockspec}
  sed -e "s/master-1/${tag}-${count}/" "${rockspec}" > "${name}"-"${tag}"-"${count}".rockspec
  luarocks upload "${name}"-"${tag}"-"${count}".rockspec --api-key="${LUAROCKS_API_KEY}"
done
cd ..
