box: saucisson/lua-testenv
build:
  steps:
    - script:
        name: "install module"
        code: |
          for dir in /home/lua/lua*; do
            if [ -d "${dir}" ]; then
              echo "Installing in ${dir}..."
              "${dir}/bin/luarocks" install compat52 || true
              "${dir}/bin/luarocks" make rockspec/*-master-1.rockspec
            fi
          done
    - script:
        name: "run checks"
        code: |
          for dir in /home/lua/lua*; do
            if [ -d "${dir}" ]; then
              echo "Checking in ${dir}..."
              "${dir}/bin/luacheck" --std=max+busted src/
            fi
          done
    - script:
        name: "run tests"
        code: |
          for dir in /home/lua/lua5*; do
            if [ -d "${dir}" ]; then
              echo "Testing in ${dir}..."
              "${dir}/bin/busted" --verbose src/
            fi
          done
    # - script:
    #     name: "run coverage"
    #     code: |
    #       /home/lua/lua52/bin/busted --coverage --verbose src/
  # after-steps:
  #   - script:
  #       name: "export to coveralls"
  #       code: |
  #         branch=$(git rev-parse --abbrev-ref HEAD)
  #         /home/lua/lua52/bin/luacov-coveralls \
  #           --repo-token "${COVERALLS_TOKEN}" \
  #           --exclude share --exclude busted --exclude _spec \
  #           --include cosy/formalism \
  #           --root src/ \
  #           --service-name "${branch}"

deploy:
  luarocks:
    - script:
        name: upload to luarocks
        code: |
          tag=$(git describe --tags --abbrev=0 || echo "0.0")
          count=$(git rev-list --count HEAD ^"${tag}" || git rev-list --count HEAD)
          cd rockspec || exit 1
          rockspec=cosy-formalisms-master-1.rockspec
          name=cosy-formalisms
          sed -e "s/master-1/${tag}-${count}/" "${rockspec}" \
            > "${name}"-"${tag}"-"${count}".rockspec
          /home/lua/lua52/bin/luarocks upload \
             --api-key="${LUAROCKS_API_KEY}" \
            "${name}"-"${tag}"-"${count}".rockspec
          cd ..
